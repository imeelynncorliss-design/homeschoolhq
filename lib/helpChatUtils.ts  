import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

export interface Conversation {
  id: string;
  user_id: string;
  created_at: string;
  updated_at: string;
  status: 'active' | 'resolved' | 'archived';
  metadata?: Record<string, any>;
}

export interface Message {
  id: string;
  conversation_id: string;
  role: 'user' | 'assistant';
  content: string;
  created_at: string;
  metadata?: Record<string, any>;
}

/**
 * Create a new help conversation
 */
export async function createConversation(userId: string): Promise<Conversation | null> {
  const { data, error } = await supabase
    .from('help_conversations')
    .insert({
      user_id: userId,
      status: 'active',
    })
    .select()
    .single();

  if (error) {
    console.error('Error creating conversation:', error);
    return null;
  }

  return data;
}

/**
 * Get active conversation for a user
 */
export async function getActiveConversation(userId: string): Promise<Conversation | null> {
  const { data, error } = await supabase
    .from('help_conversations')
    .select('*')
    .eq('user_id', userId)
    .eq('status', 'active')
    .order('updated_at', { ascending: false })
    .limit(1)
    .single();

  if (error && error.code !== 'PGRST116') { // PGRST116 is "no rows returned"
    console.error('Error fetching conversation:', error);
    return null;
  }

  return data;
}

/**
 * Get or create an active conversation for a user
 */
export async function getOrCreateConversation(userId: string): Promise<Conversation | null> {
  let conversation = await getActiveConversation(userId);
  
  if (!conversation) {
    conversation = await createConversation(userId);
  }
  
  return conversation;
}

/**
 * Save a message to a conversation
 */
export async function saveMessage(
  conversationId: string,
  role: 'user' | 'assistant',
  content: string
): Promise<Message | null> {
  const { data, error } = await supabase
    .from('help_messages')
    .insert({
      conversation_id: conversationId,
      role,
      content,
    })
    .select()
    .single();

  if (error) {
    console.error('Error saving message:', error);
    return null;
  }

  return data;
}

/**
 * Get all messages for a conversation
 */
export async function getConversationMessages(conversationId: string): Promise<Message[]> {
  const { data, error } = await supabase
    .from('help_messages')
    .select('*')
    .eq('conversation_id', conversationId)
    .order('created_at', { ascending: true });

  if (error) {
    console.error('Error fetching messages:', error);
    return [];
  }

  return data || [];
}

/**
 * Update conversation status
 */
export async function updateConversationStatus(
  conversationId: string,
  status: 'active' | 'resolved' | 'archived'
): Promise<boolean> {
  const { error } = await supabase
    .from('help_conversations')
    .update({ status })
    .eq('id', conversationId);

  if (error) {
    console.error('Error updating conversation status:', error);
    return false;
  }

  return true;
}

/**
 * Get conversation history for analytics/review
 */
export async function getUserConversationHistory(
  userId: string,
  limit: number = 10
): Promise<Conversation[]> {
  const { data, error } = await supabase
    .from('help_conversations')
    .select('*')
    .eq('user_id', userId)
    .order('updated_at', { ascending: false })
    .limit(limit);

  if (error) {
    console.error('Error fetching conversation history:', error);
    return [];
  }

  return data || [];
}